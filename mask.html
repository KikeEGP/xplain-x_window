<!doctype html>
<html>
<head>
	<meta charset=utf8>
	<title>Mask Test</title>
	<style>
	canvas { border: 1px solid #000; }
	</style>
</head>
<body class="region-demo">
	<h2>Mask Test</h2>
	<canvas id="a" width=200 height=200></canvas>
	<canvas id="b" width=200 height=200></canvas>
	<canvas id="mask" width=200 height=200 style="background-color: black;"></canvas>
	<canvas id="out" width=200 height=200></canvas>
	<script>
	(function() {
		var ctx_a = document.getElementById("a").getContext("2d");
		ctx_a.fillStyle = 'red';
		ctx_a.fillRect(20, 20, 100, 100);

		var ctx_b = document.getElementById("b").getContext("2d");
		ctx_b.fillStyle = 'green';
		ctx_b.fillRect(80, 80, 100, 100);

		var ctx_mask = document.getElementById("mask").getContext("2d");
		ctx_mask.fillStyle = ctx_mask.createRadialGradient(100, 100, 0, 100, 100, 100);
		ctx_mask.fillStyle.addColorStop(0, "rgba(255, 255, 255, 1)");
		ctx_mask.fillStyle.addColorStop(1, "rgba(255, 255, 255, 0)");
		ctx_mask.fillRect(0, 0, 200, 200);

		var ctx_out = document.getElementById("out").getContext("2d");
		ctx_out.drawImage(ctx_a.canvas, 0, 0);

		function makeCanvas(ctx) {
			var newCanvas = document.createElement("canvas");
			newCanvas.width = ctx.canvas.width;
			newCanvas.height = ctx.canvas.height;
			return newCanvas.getContext("2d");
		}

		function mask(source, mask) {
			var ctx = makeCanvas(source, mask);
			ctx.drawImage(source.canvas, 0, 0);
			ctx.globalCompositeOperation = 'destination-in';
			ctx.drawImage(mask.canvas, 0, 0);
			return ctx.canvas;
		}

		ctx_out.drawImage(mask(ctx_b, ctx_mask), 0, 0);
	})();
	</script>
</body>
</html>
