<!doctype html>
<html>
<head>
    <meta charset=utf8>
    <title>Mask Test</title>
    <style>
    canvas { border: 1px solid #000; }
    </style>
</head>
<body class="region-demo">
    <h2>Mask Test</h2>
    <canvas id="shape" width=200 height=200></canvas>
    <canvas id="a" width=200 height=200></canvas>
    <script>
    (function() {

        var ctx_shape = document.getElementById("shape").getContext("2d");
        var img = new Image();
        img.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAABlBMVEUAAAD///+l2Z/dAAAAWUlEQVRo3u3YQQoAIAgEQO3/f7YXeAiiIsbrInPwspjRTXZBLW+MODAQCAQCgUAgkMiNHa7cBAKBQCAQCORyuVtPfO4gEAgEAoFAni13PncQCAQCgUAg/yATfaoGxysJ+mUAAAAASUVORK5CYII=";
        ctx_shape.fillStyle = ctx_shape.createPattern(img, "no-repeat");
        ctx_shape.save();
        ctx_shape.translate(20, 20);
        ctx_shape.fillRect(0, 0, 100, 100);
        ctx_shape.restore();

        var ctx_a = document.getElementById("a").getContext("2d");

        function drawShape() {
            ctx_a.clearRect(0, 0, 200, 200);
            ctx_a.drawImage(ctx_shape.canvas, 0, 0);
        }

        drawShape();

        function copyArea(ctx, oldX, oldY, newX, newY, w, h) {
            ctx.drawImage(ctx.canvas, oldX, oldY, w, h, newX, newY, w, h);
        }

        function moveImage(state, ctx, fromX, fromY, toX, toY, size) {
            drawShape();

            var w = size;
            var h = size;

            var oldX = fromX, oldY = fromY;
            var newX = toX, newY = toY;

            function rect(fill, x, y, w, h) {
                ctx.save();
                ctx.fillStyle = fill;
                ctx.fillRect(x, y, w, h);
                ctx.strokeRect(x, y, w, h);
                ctx.restore();
            }

            function planCopyA() {
                rect('rgba(0, 0, 255, 0.5)', oldX, oldY, w, h);
            }

            function planCopyB() {
                rect('rgba(0, 255, 0, 0.5)', newX, newY, w, h);
            }

            function copy() {
                var ctx = ctx_shape;
                ctx.beginPath();
                ctx.save();
                ctx.rect(newX, newY, w, h);
                ctx.clip();
                copyArea(ctx_shape, oldX, oldY, newX, newY, w, h);
                ctx.restore();
                drawShape();
            }

            function planClear() {
                var diffX = Math.abs(toX - fromX);
                ctx.save();
                rect('rgba(255, 0, 0, 0.5)', fromX, fromY, diffX, h);
                ctx.restore();
            }

            function clear() {
                var ctx = ctx_shape;
                var diffX = Math.abs(toX - fromX);
                ctx.clearRect(fromX, fromY, diffX, size);
                drawShape();
            }

            return [planCopyA, planCopyB, copy, planClear, clear][state]();
        }

        var origPos = 20;
        var pos = origPos;
        var state = 0;
        window.addEventListener("keydown", function(evt) {
            var letter = String.fromCharCode(evt.keyCode);
            var newPos;
            newPos = pos + 10;
            moveImage(state++, ctx_a, pos, origPos, newPos, origPos, 100, 100);
            if (state === 5) {
                pos = newPos;
                state = 0;
            }
        });

    })();
    </script>
</body>
</html>
