<!doctype html>
<html>
<head>
	<meta charset="utf8">
	<link rel="stylesheet" href="article.css">
	<link rel="stylesheet" href="demos.css">
	<link rel="stylesheet" href="../src/inspector/inspector.css">
	<link rel="stylesheet" href="../src/server/server.css">
	<title>Xplain</title>
</head>
<body><div class="main">
	<header>
		<h1>Xplain</h1>
		<h2>Explaining X11 for the rest of us</h2>
	</header>

	<article>
		<noscript>
		<p class="warning">
			This article relies a lot of interactive demos that use JavaScript to show
			how the X Window System works. The article unfortunately won't work properly
			without these interactive demos, so if you feel like you're missing out,
			try enabling JavaScript?
		</p>
		</noscript>

		<hr>
		<h3 id="introduction">Introduction <a href="#introduction">&para;</a></h3>
		<p>
			Last year, I wrote <a href="http://blog.mecheye.net/2012/06/the-linux-graphics-stack/">
			an article</a> describing the free and open-source graphics
			stack, explaining all of the interconnected pieces: X11, graphics drivers,
			DRM, and DRI, and their roles in getting pixels placed on the screen. In
			the year since, I've answered a lot of really good questions from the
			Linux community about my post, and I've started getting more involved
			in Wayland development as part of our goal to
			<a href="https://wiki.gnome.org/Initiatives/Wayland">port GNOME to Wayland</a>.
		</p>
		<p>
			Compared to some of my colleagues, I'm relatively new to the Linux development
			scene, with only five or so years of experience. I've also arrived late,
			way after we've added lots of hacks to keep the X Window System fresh,
		</p>
		<p>
			My purpose here isn't to slam the X Window System as legacy and unusable and complain
			about it. The engineers working on Microsoft Windows made a lot of very similar design
			decisions in their display server technology back when they were developing Windows 95,
			and they've invented most of the same clever hacks to modernize their OS. As anybody
			who reads <a href="http://blogs.msdn.com/b/oldnewthing/">Raymond Chen's excellent blog</a>
			knows, Microsoft takes backwards compatibility extremely seriously, so they cannot
			introduce any changes that would break existing applications.
		</p>
		<p>
			Instead, Think of this article as a history lesson, starting way back at the X Window
			System in the 80s, and slowly tacking on everything we've introduced into Linux Graphics
			to keep it fresh, like
			<a href="http://www.x.org/releases/current/doc/renderproto/renderproto.txt">RENDER</a>,
			<a href="http://www.x.org/releases/current/doc/compositeproto/compositeproto.txt">COMPOSITE</a>,
			and <a href="http://dri.freedesktop.org/wiki/">DRI</a>.
		</p>
		<p>
			For comparison purposes, I'll also end with a modern display server, modelled after
			Wayland, to show how we can unravel all of the incremental improvements we've done
			over the years to build something fresh and exciting.
		</p>

		<hr>
		<h3 id="self-test">But before we begin... <a href="#self-test">&para;</a></h3>
		<p>
			Since this article contains a lot of interactive demos relying on fairly modern
			browser technology, let's make sure that everything is OK before continuing. I've
			been testing this on modern versions of Firefox Nightly and Chrome Canary.
		</p>
		<div class="demo-server test"></div>
		<p>
			If you can see the stipple pattern above, that means that your browser is modern
			enough to see the interactive demos.
		</p>
		<p>
			You might have noticed that when you ran your mouse over the stipple, your cursor
			changed. That's because this isn't just any old stipple image, that stipple is
			actually the background of a full X server session running in your browser using
			HTML5 canvas. All of the interactive demos will use this framework to explain what's
			going on under the hood.
		</p>

		<hr>
		<h3 id="basic-architecture">Basic Architecture <a href="#basic-architecture">&para;</a></h3>
		<p>
			Although it may sound a bit stilted, notice how I keep saying "the X Window System"
			instead of the more traditional shorthands "X", "X11", or "Xorg"? I want to be very
			careful to separate the ideas and design of the system from its component parts.
		</p>
		<p>
			The X Window System is a networked display system. A server component, the
			<strong>X server</strong>, is responsible for coordinating between all of the clients
			connected, taking input from the mouse and keyboard, and pushing pixels
			on the output. The most popular X server implementation is the <a href="http://cgit.freedesktop.org/xorg/xserver">Xorg X server</a>, developed by the X.Org Foundation. There are other X
			server implementations, such as <a href="http://en.wikipedia.org/wiki/Xsun">Xsun</a>,
			and this <a href="http://microxwin.com/">extremely scary X server</a> implemented
			as a Linux kernel module!
		</p>
		<p>
			X servers and X clients all talk a standardized network protocol to each other,
			known as <a href="http://www.x.org/releases/current/doc/xproto/x11protocol.html">X11</a>.
			These network protocols are implemented by libraries like
			<a href="http://www.x.org/releases/current/doc/libX11/specs/libX11/libX11.html">Xlib</a>
			and <a href="http://xcb.freedesktop.org/">xcb</a>.
		</p>
		<p>
			I need to be extremely careful during this article.
		</p>
		<p>
			When I talk about a feature	or design decision in the overall system, I will say "X Window System".
		</p>
		<p>
			When I talk about features or details of the network protocol, I will say "X11 protocol".
		</p>
		<p>
			When I talk about the behavior of a client or a server, I'll say "X client" or "X server".
		</p>
		<p>
			When I talk about an implementation detail in the Xorg X server, I'll say "Xorg X server".
		</p>
		<p>
			If I ever say "such-and-such is a feature of X", it's a bug.
		</p>

		<hr>
		<h3 id="lets-go">Let's go <a href="#lets-go">&para;</a></h3>
		<div class="demo-server calculatorCSD"></div>
		<p>
			Here's our example app. Excuse the programmer graphics, I'm simply just trying
			to represent <a href="http://xawm.sourceforge.net/">the state of the art of the
			time</a>. It's a simple reverse polish notiation calculator. For those of you
			not old enough to remember them, try pressing <strong>7</strong>, <strong>ENT</strong>,
			<strong>6</strong>, then press <strong>*</strong>. It's not built very well,
			and you can probably break it fairly easily by making it display <strong>NaN</strong>
			by playing around with it.
		</p>
		<p>
			But that's OK, because a stable calculator app isn't really the point here.
			While not a very complex, it's good enough that it allows us to start understanding
			the basics of the X Window System.
		</p>
		<p>
			You might notice that <span class="inspector-icon">i</span> button in the top right
			of the X server display. Click on it, and the inspector will pop open. On the left
			side is the window tree, and on the right side are the properties and attributes for
			the selected window.
		</p>
		<p>
			<q>Wait a minute... window <em>tree</em>?</q>
		</p>
		<p>
			Yes. While you might imagine that the calculator above looks like it's only one window,
			it's actually built of 15 distinct windows. In the X Window System, as you can possibly
			imagine, a <em>window</em> is the basic building block of the system. At a basic level,
			they're a rectangle that can receive input, and show output on the screen.
		</p>
		<p>
			Windows always have a parent. Windows live in the coordinate space of their parent, and
			the bounds of
			<em><a href="http://www.x.org/releases/current/doc/xproto/x11protocol.html#glossary:Inferiors">inferior windows</a></em>,
			or child windows, are clipped to their parent. By default, every window is parented to
			the <em>root window</em>, a special window owned and created by the X server.
		</p>
		<p>
			This appears to make a nice, appealing recursive structure. Windows are themselves
			tiny display servers, aggregating the contents of their children up the tree, until
			we get to the root window, which the X server manages itself. However, there are lots
			of complications with this approach, especially when dealing with input and drawing.
		</p>
		<p>
			So... uh, let's just dive right in and see what falls out.
		</p>

		<hr>
		<h3 id="expose-model">Exposing historical baggage</h3>
		<div class="demo-server expose"></div>
		<p>
			
		</p>

		<hr>
		<h3 id="credits">Credit where credit's due <a href="#credits">&para;</a></h3>
		<p>
			The source code to this article and all demos is freely available under the MIT/X11
			license on <a href="http://github.com/magcius/xserver.js">GitHub</a> for inspection.
		</p>

		<p>
			Some of the more tricky code in there has been ported from the
			<a href="http://cgit.freedesktop.org/xorg/xserver">Xorg X server</a> itself, and
			the code doing region calculations has been compiled from the
			<a href="http://cgit.freedesktop.org/pixman/">pixman</a> graphics library
			using <a href="https://github.com/kripken/emscripten">emscripten</a>.
		</p>

		<p>
			Special thanks to <a href="http://keithp.com/">Keith Peters</a>,
			<a href="https://blogs.oracle.com/alanc/">Alan Coopersmith</a>,
			<a href="http://people.freedesktop.org/~ajax/">Adam Jackson</a>,
			<a href="http://who-t.blogspot.com/">Peter Hutterer</a>, and
			<a href="http://fishsoup.net/">Owen Taylor</a> for digging into the source code,
			protocols, mailing lists and other archives to help me figure out some of the more
			hairy X semantics I had to write into the source code. Sorry for driving you guys
			crazy with this project.
		</p>
	</article>

	<script src="../src/pixman-region.js"></script>
	<script src="../src/pixman-region-wrapper.js"></script>
	<script src="../src/class.js"></script>
	<script src="../src/server/server.js"></script>
	<script src="../src/clients/wm.js"></script>
	<script src="../src/clients/toolkit.js"></script>
	<script src="../src/clients/calculator.js"></script>
	<script src="../src/inspector/inspector.js"></script>
	<script src="demos.js"></script>
</div></body>
</html>
