<!doctype html>
<html>
<head>
	<meta charset="utf8">
	<script>
		// Hi there! Since you're looking at this, I'm sure you'd like to know a
		// bit more about the demos in this article.
		//
		// For starters, as I mention at the end of the article, the code that
		// powers all the demos in this article is at GitHub:
		//
		// https://github.com/magcius/xserver.js
		//
		// Most of the code that I've written is in the X server itself,
		// which can be found at src/server/server.js
		//
		// The extensive "Inspector" can be found in src/inspector/inspector.js
		//
		// The rest of the demos are clients that connect to that server, and
		// they can be found in src/article-demos/.
		//
		// The main demo "runner" framework is at src/article-demos/demos.js,
		// and the code for all the demos in the article are littered around
		// in that directory.
		//
		// I've tried to document it quite well, but if you have any more questions
		// about the code, about anything in this article, or just want to flame
		// me about Wayland or Mir, feel free to contact me through email.
		//
		// I can be reached at <jstpierre@mecheye.net>
		//
		// --
		//   Jasper
		//
		// P.S. I tried to find one of those Medium-style "margin comment"
		// systems so people could comment on this article in one place,
		// but couldn't find any hosted or open-source solutions I could
		// deploy! Disqus, other startups, please write this!
	</script>

	<link rel="stylesheet" href="article.css">
	<link rel="stylesheet" href="../src/article-demos/demos.css">
	<link rel="stylesheet" href="../src/inspector/inspector.css">
	<link rel="stylesheet" href="../src/server/server.css">
	<link rel="shortcut icon" href="favicon.png">
	<title>Xplain</title>
</head>
<body><div class="main">
	<header>
		<h1><span>Xplain</span></h1>
		<h2>Explaining X11 for the rest of us</h2>
	</header>

	<article>
		<noscript>
		<p class="warning">
			This article relies a lot of interactive demos that use JavaScript to show how the X Window System works.
			The article unfortunately won't work properly without these interactive demos, so if you feel like you're
			missing out, try enabling JavaScript?
		</p>
		</noscript>

		<section id="introduction">
		<h3>Introduction</h3>
		<p>
			Last year, I wrote <a href="http://blog.mecheye.net/2012/06/the-linux-graphics-stack/"> an article</a>
			describing the free and open-source graphics stack, explaining all of the interconnected pieces: X11,
			graphics drivers, DRM, and DRI, and their roles in getting pixels placed on the screen. In the year since,
			I've answered a lot of really good questions from the Linux community about my post, and I've started
			getting more involved in Wayland development as part of our goal to <a
			href="https://wiki.gnome.org/Initiatives/Wayland">port GNOME to Wayland</a>.
		</p>
		<p>
			Compared to some of my colleagues, I'm relatively new to the Linux development scene, with only five or so
			years of experience. I've also arrived late, way after we've added lots of hacks to keep the X Window
			System fresh.
		</p>
		<p>
			My purpose here isn't to discredit the X Window System entirely as a series of bad decisions one after
			another, and praise Wayland as the holy grail of desktop development. I do believe that the future of
			display server technology is with a design like Wayland as opposed to something more antiquated X11.
		</p>
		<p>
			Instead, Think of this article as a history lesson, starting way back at the X Window System in the 80s,and slowly tacking on everything we've introduced into Linux Graphics to keep it fresh, like
			<a href="http://www.x.org/releases/current/doc/renderproto/renderproto.txt">RENDER</a>,
			<a href="http://www.x.org/releases/current/doc/compositeproto/compositeproto.txt">COMPOSITE</a>, and
			<a href="http://dri.freedesktop.org/wiki/">DRI</a>. I'm here to lay out the facts, give some historical
			records, and hopefully teach you a few things about how X works internally if you've ever had trouble
			understanding it.
		</section>

		<section id="self-test">
		<h3>But before we begin...</h3>
		<p>
			Since this article contains a lot of interactive demos relying on fairly modern browser technology, let's
			make sure that everything is OK before continuing. I've been testing this on modern versions of Firefox
			Nightly and Chrome Canary.
		</p>
		<div class="demo-server" data-demo="test"></div>
		<p>
			If you can see the stipple pattern above, that means that your browser is modern enough to see the
			interactive demos.
		</p>
		<p>
			You might have noticed that when you ran your mouse over the stipple, your cursor changed. That's because
			this isn't just any old stipple image, that stipple is actually the background of a full X server session
			running in your browser using HTML5 canvas. All of the interactive demos will use this framework to explain
			what's going on under the hood.
		</p>
		</section>

		<section id="basic-architecture">
		<h3>Basic Architecture</h3>
		<p>
			Although it may sound a bit stilted, notice how I keep saying "the X Window System" instead of the more
			traditional shorthands "X", "X11", or "Xorg"? I want to be very careful to separate the ideas and design of
			the system from its component parts.
		</p>
		<p>
			The X Window System is a networked display system. A server component, the <strong>X server</strong>, is
			responsible for coordinating between all of the clients connected, taking input from the mouse and
			keyboard, and pushing pixels on the output. The most popular X server implementation is the
			<a href="http://cgit.freedesktop.org/xorg/xserver">Xorg X server</a>, developed by the X.Org Foundation and
			community. There are other X server implementations: you might remember that Xorg was forked from
			<a href="http://www.xfree86.org/">XFree86</a> a decade ago, that Sun Microsystems has had several X server
			implementations, in both <a href="http://en.wikipedia.org/wiki/Xsun">Xsun</a> and
			<a href="http://en.wikipedia.org/wiki/Xnews_%28X11_server%29">XNeWS</a>. Today, Xorg is the dominant X
			server implementation, getting most of the development. But back in the day, multiple competing
			implementations existed.
		</p>
		<p>
			X servers and X clients all talk a standardized network protocol to each other, known as
			<a href="http://www.x.org/releases/current/doc/xproto/x11protocol.html">X11</a>. This protocol is
			well-specified, from the wire format to the semantics of every request. The protocol documentation linked
			above is invaluable documentation for any hacker who wants to learn more about this stuff.
		</p>
		<p>
			Applications and toolkits don't write the wire format onto the socket directly, however. They often use
			client libraries that implement the protocols, like the traditional
			<a href="http://www.x.org/releases/current/doc/libX11/specs/libX11/libX11.html">Xlib</a> library, or the
			somewhat newer <a href="http://xcb.freedesktop.org/">xcb</a>.
		</p>
		<p>
			I'm going to try and be precise in my nomenclature in this article.
		</p>
		<p>
			When I talk about features or design decisions of the overall system, I will try to call it <em>the X
			Window System</em>, even if it sounds a bit verbose. e.g. <q><em>The X Window System</em> provides us
			Pixmaps, which are images in the server's memory.</q>
		</p>
		<p>
			When I talk about features or details of the network protocol, I will talk about <em>the X11 protocol</em>.
			e.g. <q><em>The X11 protocol</em> provides for a generic extension mechanism, which allows for a
			forward-compatible way to implement new features without having to redesign older parts of X11</q>.
		</p>
		<p>
			When I talk about the behavior of a client or a server, I'll say <em>X client</em> or <em>X server</em>
			e.g. <q>Using the MIT-SHM extension, <em>X clients</em> can pass memory buffers to the <em>X server</em>
			using POSIX shared memory, which prevents networking and large copies</q>.
		</p>
		<p>
			When I talk about features or the architecture in the Xorg X server implementation, I'll mention it
			explicitly as <em>Xorg</em> or <em>the Xorg X server</em>, e.g. <q>In order to make drawing calls accelerated, <em>Xorg</em> video drivers can provide hardware-accelerated versions of certain drawing primitives through EXA.</q>
		</p>
		<p>
			If I ever say "such-and-such is a feature of X", it's a bug.
		</p>
		</section>

		<section id="lets-go">
		<h3>Let's go</h3>
		<div class="demo-server demo-inspectable" data-demo="calculatorCSD"></div>
		<p>
			Here's our example app. Excuse the programmer graphics, I'm simply just trying to represent
			<a href="http://xawm.sourceforge.net/">the state of the art of the time</a>. It's a simple reverse polish
			notiation calculator. For those of you not old enough to remember them, try pressing <strong>7</strong>,
			<strong>ENT</strong>, <strong>6</strong>, then press <strong>*</strong>. It's not built very well, and you
			can probably break it fairly easily by making it display <strong>NaN</strong> by playing around with it.
		</p>
		<p>
			But that's OK, because a stable calculator app isn't really the point here. While not a very complex, it's
			good enough that it allows us to start understanding the basics of the X Window System.
		</p>
		<p>
			You might notice that <span class="inspector-icon">i</span> button in the top right of the demo above.
			Click on it, and the inspector will pop open. On the left side is the window tree, and on the right side
			are the properties and attributes for the selected window.
		</p>
		<p>
			<q>Wait a minute... window <em>tree</em>?</q>
		</p>
		<p>
			Yes. While you might imagine that the calculator above looks like it's only one window to us, the users,
			it's actually built of 15 distinct windows. In the X Window System, as you can possibly imagine, a
			<em>window</em> is the basic building block of the system. At a very basic level, windows are simply
			rectangles that can receive input events like keyboard and mouse events, and display pixels in their area.
		</p>
		<p>
			Windows always have a parent. Windows live in the coordinate space of their parent, and the bounds of
			<em><a href="http://www.x.org/releases/current/doc/xproto/x11protocol.html#glossary:Inferiors">inferior
			windows</a></em>, or child windows, are clipped to their parent. By default, every window is parented to
			the <em>root window</em>, a special window owned and created by the X server.
		</p>
		<p>
			If this sounds familiar to you, you might realize that this sounds an awful lot like the DOM tree
			in HTML. A recursive data structure where every node can take input and draw to the screen... and
			I don't blame you. However, windows in the X Window System and HTML-style DOM nodes have a lot of
			subtle differences that make the X Window System's abstractions a bit less useful for building
			widgets on. And that's what we're gonna be exploring next.
		</p>
		</section>

		<section id="expose-model">
		<h3>Exposing historical baggage</h3>
		<p>
			In the late 80s, when the X Window System was designed, RAM was costly, and was a scarce resource.
			If we stored window contents in system memory, if you want to have a maximzed window, that would be,
			well, 1 byte * (800 * 600 pixels) =
			<a href="https://www.google.com/search?q=1%20byte%20*%20800%20*%20600%20=">almost half a megabyte!</a>
			The user can't open more than 10 maximized windows before exhausting the 5MB in his workstation, and
			with 16-bit True Color around the corner, we can't fit more than 5! No, no, this can't possibly scale.
		</p>
		<p>
			So, if we can't store window pixels in system memory, where can we store them? They have to exist
			somewhere, <em>right</em>?
		</p>
		<p>
			Nope. The trick the X Window System authors realized is that the pixels for a window don't have to exist
			at all. We only have one giant buffer of pixels for the entire screen, the <em>front buffer</em>, and
			windows borrow pixels to draw to.
		</p>
		<div class="demo-server demo-inspectable" data-demo="expose"></div>
		<p>
			The demo above shows two windows, with one window obscuring the other. The window underneath moves from
			side to side, and you can see that when it moves, the window blanks out for a moment before redrawing
			itself.
		</p>
		<p>
			The window on top, marked as <span class="code-literal">kitten1.jpg</span> in the inspector, owns
			a rectangle in the center of the screen. The window below, <span class="code-literal">kitten2.jpg</span>,
			owns a "L" shape slightly above and to the left.
		</p>
		<p>
			When the X server needs pixels from a window, it tells the window to redraw the area it's missing
			pixels for using an
			<a href="http://www.x.org/releases/current/doc/xproto/x11protocol.html#events:Expose" class="code-literal">
			Expose</a> event. The window then responds by submitting drawing commands back to the X server.
			The X server then processes all these drawing commands, touching pixels on the front buffer where the
			window is.
		</p>
		<p>
			You can also drag <span class="code-literal">kitten1.jpg</span> around. Try it, and see if you can figure
			out how this behaves.
			<a href="http://www.mrdoob.com/lab/javascript/effects/ie6/">Does it seem familiar?</a> The authors of
			Windows 95 chose the same design when they wrote their display server, however they called their Expose
			like event
			<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd145213%28v=vs.85%29.aspx" class="code-literal">WM_PAINT</a>
			instead.
		</p>
		</section>

		<section id="credits">
		<h3>Credit where credit's due</h3>
		<p>
			The source code to this article and all demos is freely available under the MIT/X11 license on
			<a href="http://github.com/magcius/xserver.js">GitHub</a> for inspection.
		</p>
		<p>
			Some of the more tricky code in there has been ported from the
			<a href="http://cgit.freedesktop.org/xorg/xserver">Xorg X server</a> itself, and the code doing region
			calculations has been compiled from the <a href="http://cgit.freedesktop.org/pixman/">pixman</a> graphics
			library	using <a href="https://github.com/kripken/emscripten">emscripten</a>.
		</p>
		<p>
			Some of the images in this article have been adapted from other images on the web. The two kitten images
			in the Expose event demo were adapted from photos taken by
			<a href="http://www.flickr.com/photos/titrans/">quatre mains</a> and
			<a href="http://www.flickr.com/photos/fazen/">fazen</a>, shared under a
			<a href="http://creativecommons.org/licenses/by/2.0/">CC-BY-2.0</a> license. Thanks to
			<a href="http://placekitten.com/attribution.html">[placekitten]</a> for finding these images for me.
		</p>
		<p>
			The cursors used in the demos are from the cursors used by GNOME's default theme,
			<a href="https://git.gnome.org/browse/gnome-themes-standard/tree/themes/Adwaita/cursors">Adwaita</a>. 
			Icons used in the inspector have been adapted from
			<a href="https://git.gnome.org/browse/gnome-icon-theme-symbolic">GNOME Symbolic Icon Theme</a> and
			<a href="https://github.com/gnome-design-team/gnome-icons/tree/master/art-libre-symbolic">GNOME Art
			Libre Symbolic Icon Theme</a>, shared under the LGPL and CC-BY-SA-3.0. All rights reserved.
		</p>
		<p>
			Special thanks to <a href="http://keithp.com/">Keith Peters</a>,
			<a href="https://blogs.oracle.com/alanc/">Alan Coopersmith</a>,
			<a href="http://people.freedesktop.org/~ajax/">Adam Jackson</a>,
			<a href="http://who-t.blogspot.com/">Peter Hutterer</a>, and
			<a href="http://fishsoup.net/">Owen Taylor</a> for digging into the source code, protocols, mailing lists
			and other archives to help me figure out some of the more hairy X semantics I had to write into the source
			code. Sorry for driving you guys crazy with this project.
		</p>
		</section>
	</article>

	<script src="article.js"></script>

	<script src="../src/pixman-region.js"></script>
	<script src="../src/pixman-region-wrapper.js"></script>
	<script src="../src/class.js"></script>
	<script src="../src/canvas-util.js"></script>
	<script src="../src/server/server.js"></script>
	<script src="../src/clients/wm.js"></script>
	<script src="../src/clients/toolkit.js"></script>
	<script src="../src/clients/calculator.js"></script>
	<script src="../src/inspector/inspector.js"></script>

	<script src="../src/article-demos/demos.js"></script>
	<script src="../src/article-demos/expose.js"></script>

	<script>
		(function() {
			"use strict";

			window.addEventListener("load", function() {
				// Generate all the section permalinks
				Article.generateSectionLinks();

				// Run all the demos
				ArticleDemos.runAllDemos();
			});
		})();
	</script>
</div></body>
</html>
