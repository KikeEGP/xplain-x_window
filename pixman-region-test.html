<!doctype html>
<html>
<head>
	<meta charset=utf8>
	<title>Region Demos</title>
	<link rel="stylesheet" href="demo.css">
</head>
<body class="region-demo">
	<script src="http://ajax.googleapis.com/ajax/libs/mootools/1.4.5/mootools-yui-compressed.js"></script>
	<script src="pixman-region.js"></script>
	<script>
	function repeat(x, n) {
		var L = [];
		for (var i = 0; i < n; i++)
			L.push(x);
		return L;
	}

	function StructWrapper(props) {
		var type = props.StructName;
		var typeInfo = Runtime.typeInfo['%struct.' + type];
		var size = typeInfo.flatSize;

		var fieldNames = props.Fields;
		if (typeInfo.fields.length != fieldNames.length)
			throw new Error("Invalid fields");

		var constructor = function(ptr) {
			this.$internal = ptr;
		};
		constructor.type = type;
		constructor.typeInfo = typeInfo;
		constructor.size = typeInfo.flatSize;

		var descs = {};

		fieldNames.forEach(function(name, i) {
			var off = typeInfo.flatIndexes[i];
			var type = typeInfo.fields[i];
			descs[name] = { get: function() {
				return getValue(this.$internal + off, type);
			} };
		});

		Object.defineProperties(constructor.prototype, descs);

		return constructor;
	}

	function TypeWrapper(props) {
		var type = props.TypeName;
		var typeInfo = Runtime.typeInfo['%struct.' + type];
		var size = typeInfo.flatSize;

		var init = props.Initialize;
		var free = props.Finalize;

		var constructor = function() {
			this.$internal = _malloc(size);
			this[init].apply(this, arguments);
		};
		constructor.type = type;
		constructor.typeInfo = typeInfo;
		constructor.size = size;

		var proto = constructor.prototype;
		props.AutoBind.forEach(function(desc) {
			var name = desc.name;
			var args = ['this'].concat(desc.args);
			var nargs = args.length;

			var cname = type + '_' + name.replace(/^_/, '');
			proto[name] = function() {
				var args = [].slice.call(arguments);
				args.unshift(this);
				if (args.length != nargs)
					throw new Error("Invalid number of args");
				args = args.map(function(x) {
					if (x.$internal)
						return x.$internal;
					else
						return x;
				});

				return ccall(cname, 'number', repeat('number', nargs), args);
			};
		});

		proto.finalize = function() {
			// emscripten has issues with free right now.
			// _free(this.$internal);
			this[free].apply(this, arguments);
		};

		return constructor;
	}

	var Box = new StructWrapper({
		StructName: 'pixman_box32',
		Fields: ['x1', 'y1', 'x2', 'y2']
	});
	Object.defineProperties(Box.prototype, {
		x: { get: function() { return this.x1; } },
		y: { get: function() { return this.y1; } },
		width: { get: function() { return this.x2 - this.x1; } },
		height: { get: function() { return this.y2 - this.y1; } },
	});

	var Region = new TypeWrapper({
		TypeName: 'pixman_region32',
		Initialize: 'init_rect',
		Finalize: 'fini',
		AutoBind: [
		    {name: "init", args: []},
		    {name: "init_rect", args: ["x", "y", "width", "height"]},
		    {name: "fini", args: []},
		    {name: "union", args: ["r1", "r2"]},
		    {name: "union_rect", args: ["source", "x", "y", "width", "height"]},
		    {name: "intersect", args: ["r1", "r2"]},
		    {name: "intersect_rect", args: ["source", "x", "y", "width", "height"]},
		    {name: "subtract", args: ["r1", "r2"]},
		    {name: "subtract_rect", args: ["source", "x", "y", "width", "height"]},
		    {name: "n_rects", args: []},
		    {name: "_rectangles", args: []},
		]
	});
	Region.prototype.get_rectangle = function(idx) {
		return new Box(this._rectangles() + Box.size*idx);
	};

	</script>
</body>
</html>
